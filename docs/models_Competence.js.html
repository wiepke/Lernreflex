<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width">
	<title>Lernreflex Source: models/Competence.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.flatly.css">

</head>

<body>

<div class="navbar navbar-default navbar-fixed-top ">
<div class="container">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">Lernreflex</a>
		<button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#topNavigation">
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
			<span class="icon-bar"></span>
        </button>
	</div>
	<div class="navbar-collapse collapse" id="topNavigation">
		<ul class="nav navbar-nav">
			
			<li class="dropdown">
				<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-styles-_.html">styles~_</a></li><li><a href="module-styles-comp.html">styles~comp</a></li><li><a href="module-styles-user.html">styles~user</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="module-styles.html">styles</a></li>
				</ul>
			</li>
			
			<li class="dropdown">
				<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b class="caret"></b></a>
				<ul class="dropdown-menu ">
					<li><a href="Activity.html">Activity</a></li><li><a href="ActivityView.html">ActivityView</a></li><li><a href="Admin.html">Admin</a></li><li><a href="Badge.html">Badge</a></li><li><a href="BadgeList.html">BadgeList</a></li><li><a href="Competence.html">Competence</a></li><li><a href="CompetenceCreate.html">CompetenceCreate</a></li><li><a href="CompetenceList.html">CompetenceList</a></li><li><a href="CompetenceView.html">CompetenceView</a></li><li><a href="Course.html">Course</a></li><li><a href="InputScrollView.html">InputScrollView</a></li><li><a href="LearningTemplate.html">LearningTemplate</a></li><li><a href="Lernreflex.html">Lernreflex</a></li><li><a href="lib.html">lib</a></li><li><a href="ListEntryCompetence.html">ListEntryCompetence</a></li><li><a href="Loader.html">Loader</a></li><li><a href="Menu.html">Menu</a></li><li><a href="Model.html">Model</a></li><li><a href="Questions.html">Questions</a></li><li><a href="Router.html">Router</a></li><li><a href="SelectList.html">SelectList</a></li><li><a href="SuperComponent.html">SuperComponent</a></li><li><a href="User.html">User</a></li><li><a href="UserList.html">UserList</a></li><li><a href="UserLogin.html">UserLogin</a></li>
				</ul>
			</li>
			
		</ul>
        
            <div class="col-sm-3 col-md-3">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search" name="q" id="search-input">
                        <div class="input-group-btn">
                            <button class="btn btn-default" id="search-submit"><i class="glyphicon glyphicon-search"></i></button>
                        </div>
                    </div>
                </form>
            </div>
        
	</div>

</div>
</div>


<div class="container" id="toc-content">
<div class="row">

	
	<div class="col-md-12">
	
		<div id="main">
			

		<h1 class="page-title">Source: models/Competence.js</h1>
    
<section>
    <article>
        <pre
            class="sunlight-highlight-javascript linenums">'use strict'
import Model from 'Lernreflex/models/Model';
import {LearningTemplate, Course, Activity, User, lib} from 'Lernreflex/imports'

/**
 * Represents a competence/goal. (Model) The difference between a competence and a goal is, that
 * a goal is a competence, that was not reached yet.
 * @extends Model
 * @constructor
 * @param {bool} caching - If data can be fetched from cache.
 */

class Competence extends Model{

  constructor(caching = true){
    super('Competence', caching);
    this.urls = {
      competences: ''
    }
    /** Scales for the self assessment */
    this.scales = {
      progress: {unit:'%', values:['0', '10', '20','30','40','50','60','70','80','90','100']},
      time: {unit:'Min', values:['0 - 10', '10 - 20', '20 - 30', '30 - 60', '60 - 120', '120 - 180', '> 180']},
      interest: {unit:'', values:['Sehr klein', 'Klein', 'Mittel', 'Groß', 'Sehr groß']}
    };

    /** Stub for a competence */
    this.definition = {
      operator: '*',
      forCompetence: '*',
      catchwords:['*'],
      subCompetences: ['*'],
      superCompetences: ['*'],
      learningProjectName: '*'
    };
    this.setApi(1);
  }

  /**
  * Save a competence object to the API
  * @param obj {object} A competence object that has everything defined in the definition
  */
  save(obj){
    var key = obj.isGoal ? 'goals' : 'competences';
    obj = this.checkDefinition(obj);
    if(obj){
      let id = this.generateID(obj);
      console.log(this.lastRequest);
      this.getItem(key, {})
      .then((comps) => {comps[id] = obj; return comps;})
      .then((comps) => super.save(key, comps));
      return this.put('competences/'+(id), obj);
    }
  }

  /**
  * Return the ID of a competence object
  * @param obj {object} competence
  * @return {string}
  */
  generateID(obj){
    return obj.forCompetence;
  }

  /**
  * Get the overview of competences and goals for a user from the API
  * @return {Promise}
  */
  getOverview(type = 'competences'){ //faster to get learnigntemplates and courses and competences
    let user = new User();
    return user.isLoggedIn().then((u) => {
      return this.get('users/'+u.username+'/overview');
    });
  }

  /**
  * Get the goals for a user from the API
  * @return {Promise}
  */
  getGoals(){
    return this.getCompetences('goals');
    //return this.getItem('goals', {}).then(this.mapToNumericalKeys);
  }

  /**
  * Get the competences for a user from the API
  * @return {Promise}
  */
  getCompetences(type = 'competences'){
    let learningTemplate = new LearningTemplate();
    let user = new User();
    return user.isLoggedIn().then((user) => {
      return this.getOverview(type).then((ov) => {
        console.log(ov);
        if(!ov) return {};
        let together = {};
        if(ov.courses &amp;&amp; ov.courses.length > 0){ //From courses
          ov.courses.map((course) => {
            if(course.courseId != learningTemplate.courseContext) {
              together[course.printableName] = course.competences.map((comp) => {
                return {name:comp, text:this.toIch(comp), inCourse:true, courseId: course.courseId}
              });
            }
          });
        }
        if(ov.learningTemplates &amp;&amp; ov.learningTemplates.length > 0) {
          ov.learningTemplates.map((l) => {
            if(!l.competences) return null;
            together[l.selectedTemplate] = l.competences.map((comp) => {
              return {name:comp, text:this.toIch(comp)}
            });
          });
        }
        return this.getProgress().then((progress) => {
          together = this.joinProgressAndCompetences(together, progress);
          return this.checkHasNewGoalReached(together, user, type).then(() => this.filterType(together, type, user)
        );
      });
    });
  });
}

/**
* Count competences
* @param competences {object} Object containing lists of competences
* @return {int} summed number of competences from all lists
*/
countCompetences(competences){
  let count = 0;
  for(var category in competences) {
    count += competences[category].length;
  }
  return count;
}

/**
* Check if the number of goals has changed after loading from the server,
* to see if the user reached a new goal.
* @param allCompetences {object} Object containing lists of competences retrieved from the API
* @param user {object} Object containing username
* @param type {string} goals or competences (not used yet)
* @return {Promise}
*/
checkHasNewGoalReached(allCompetences, user, type){
  let itemName = 'allCompetences';
  console.log(allCompetences);
  if(!allCompetences || !Object.keys(allCompetences).length) return this.setItem(itemName, allCompetences);
  return this.getItem(itemName, false).then((allOldCompetences) => {
    if(!allOldCompetences || !Object.keys(allOldCompetences).length) return this.setItem(itemName, allCompetences);
    let oldGoals = this.filterType(allOldCompetences, 'goals', user);
    let oldCompetences = this.filterType(allOldCompetences, 'competences', user);
    let newGoals = this.filterType(allCompetences, 'goals', user);
    let newCompetences = this.filterType(allCompetences, 'competences', user);
    console.log(this.countCompetences(newGoals), this.countCompetences(oldGoals), this.countCompetences(oldCompetences), this.countCompetences(newCompetences));
    let newGoalReached = false;
    if(this.countCompetences(newGoals) &lt; this.countCompetences(oldGoals) &amp;&amp; this.countCompetences(oldCompetences) &lt; this.countCompetences(newCompetences) ) {
      console.log('new GOAL Reached!');
      newGoalReached = true;
      this.newGoalsReached = this.countCompetences(newCompetences) - this.countCompetences(oldCompetences);
    }
    return this.setItem(itemName, allCompetences);
  });
}

/**
* Joins the goals and competences from the API with the progress of the user
* from the API
* @param together {object} Competences from the API
* @param progress {object} Progress from the API
* @return {object} Competences with progress attached
*/
joinProgressAndCompetences(together, progress){
  Object.keys(together).map((key) => {
    let comps = together[key];
    //console.log(together, progress);
    if(typeof(comps) != 'object') return;
    together[key] = together[key].map((comp) => {
      if(progress &amp;&amp; progress[comp.name]){
        comp.progress = progress[comp.name];
      } else {
        comp.progress = this.progressToView({competence:comp.name});
      }
      return this.toView(comp);
    });
  });
  return together;
}

/**
* Filters goals OR competences from a list of both
* @param competences {object} list of competences from the API
* @param type {string} goals OR competences
* @param user {object} Object containing the username
*/
filterType(competences, type = 'competences', user){ //Filter if learning goal is reached or not
  //console.log(competences);
  let filtered = {};
  for(var category in competences) {
    if(competences[category] &amp;&amp; competences[category].length)
    filtered[category] = competences[category].filter((c) => {
      let done = (!c.inCourse &amp;&amp; c.progress &amp;&amp; c.progress.PROGRESS &amp;&amp; c.progress.PROGRESS.assessmentIndex == 10)
      || (c.inCourse &amp;&amp; this.hasCommentFromOtherUser(c, user.username));
      return type == 'competences' &amp;&amp; done || type == 'goals' &amp;&amp; !done;
    });
    if(!filtered[category] || !filtered[category].length) delete filtered[category];
  }
  return filtered;
}

/**
* Check if a user has a comment to an activity of a competence from another user,
* to see if the competence is done.
* @param competence {object} competence with progress
* @param username {string}
* @return {bool}
*/
hasCommentFromOtherUser(competence, username){
  if(competence.progress &amp;&amp; competence.progress.evidences) {
    for(var i in competence.progress.evidences) {
      let e = competence.progress.evidences[i];
      if(e.comments &amp;&amp; e.comments.filter((c) => c.user != username).length > 0) {
        return true;
      }
    }
  }
  return false;
}

/**
* Get the progress for all the competences of a user.
* @param username {string}
* @return {Promise}
*/
getProgress(username){
  let user = new User();
  let callback = (d) => {
    if(!d || !d.userCompetenceProgressList) return false;
    let progress = {};
    d.userCompetenceProgressList.map(this.progressToView).map((p) => {
      progress[p.competence] = p;
    });
    return progress;
  };
  //console.log('USER-Progress:', username);
  if(username) {
    return this.get('progress/'+username).then(callback);
  }
  return user.isLoggedIn().then((u) => {
    return this.get('progress/'+u.username).then(callback);
  })
}

/**
* Converts a progress object from the API for the use in the app
* @param p {object} progress from the API
* @return {object}
*/
progressToView(p){
  let pro = {
    name: p.competence,
    competence: p.competence,
  }

  if(!p.abstractAssessment || !Object.keys(p.abstractAssessment).length) {
    pro = {...pro, PROGRESS:{assessmentIndex:0}, TIME:{assessmentIndex:0}}
  } else
  p.abstractAssessment.map((a) => {
    pro[a.typeOfSelfAssessment] = a;
  })

  //console.log('ProgressToView', pro);
  pro.evidences = p.competenceLinksView;
  pro.answers = p.reflectiveQuestionAnswerHolder ? p.reflectiveQuestionAnswerHolder.data : [];
  return pro;
}

/**
* Get the questions for a competence
* @param competenceId {string} Id of the competence
* @return {Promise}
*/
getQuestions(competenceId){
  let caching = this.caching;
  this.caching = false;
  return this.get('competences/'+competenceId+'/questions').then((d) => {
    let questions = d ? d.map((q) => q.question) : [];
    console.log(questions);
    this.caching = caching;
    return questions.map((q, i) => { return {text:q, index:i}; });
  })
}

/**
* Saves changes made to the progress (Time or progress changed) of a competence
* @param p {object} Progress to save to the API
* @return {Promise}
*/
saveProgress(p){
  let progress = {
    userCompetenceProgressList: [{
      competence: p.competence,
      competenceLinksView: [],
      abstractAssessment: [{
        typeOfSelfAssessment: p.identify.toUpperCase(),
        assessmentIndex: p.value,
        learningGoal: false,
        minValue: p.minValue,
        maxValue: p.maxValue
      }
    ]}
  ]}
  progress = progress.userCompetenceProgressList[0];
  let user = new User();
  return user.isLoggedIn().then((u) => {
    //console.log('USER-PROGRESS', JSON.stringify(progress));
    return this.put('progress/'+u.username+'/competences/'+progress.competence, progress)
    .then(() => this.progressToView(progress));
  })
}

/**
* Changes the format of the answers from the API for use in the app
* @param competenceData {object} Competence object with progress with answers
* @param questions {object} List of questions from the server
* @return {object}
*/
answersToView(competenceData, questions){
  let answersQ = {};
  let answers = {};
  let unordered = {};
  answersQ = lib.functions.setKeys(competenceData.progress.answers, 'questionId');
  console.log(answersQ);
  console.log(questions);
  for(let i in answersQ) {
    for(var j in questions){
      //console.log(i, questions[j].text, i.indexOf(questions[j].text));
      if(i.indexOf(questions[j].text) > -1) {
        let t = questions[j].text;
        if(!unordered[t]) unordered[t] = [];
        unordered[t].push(answersQ[i]);
      }
    }
  }
  for(let i in unordered){
    answers[i] = unordered[i].sort((a, b) => a.datecreated &lt; b.datecreated)[0].text;
  }
  console.log(answers);
  return answers;
}

/**
* Saves answers to the API
* @param competenceData {object} Competence data
* @param answers {array} List of answers
* @return {Promise}
*/
saveAnswers(competenceData, answers){
  //console.log(competenceData, answers);
  let user = new User();
  let promises = [];
  return user.isLoggedIn().then((u) => {
    /*let obj = {
    competence: competenceData.name,
    reflectiveQuestionAnswerHolder:{data:answers.map((a) => {a.userId = u.username; return a})},
    competenceLinksView: [],
    abstractAssessment: []
  };*/
  answers = answers.map((a) => {
    a.userId = u.username;
    a.competenceId = competenceData.name;
    return a
  });
  for(var i in answers) {
    promises.push(this.put('competences/questions/answers', answers[i]));
  }
  return Promise.all(promises);
});
}

/**
* Parses competences from the server and checks if competences are subcompetences
* of other competences
* @param d {object} Data that should be parsed
* @return {object}
*/
parseFromTree(d){
  var _this = this;
  if(!d || !Object.keys(d).length ){
    return [];
  }
  d = d[0].children;
  if(!d || !Object.keys(d).length){
    return [];
  }
  var subs = {};
  for(var i in d) {
    subs = {...subs, ...this.treeSubCompetences(d[i].children, {})};
  }

  d = d.filter((e) => {
    return !subs[e.name];
  });
  return d;
}

/**
* Get an array of all subCompetences as keys
* @param d {array}
* @param subs {object}
* @return {object}
*/
treeSubCompetences(d, subs){
  var _this = this;
  d.map((e) => {
    subs[e.name] = true;
    if(e.children.length){
      subs = _this.treeSubCompetences(e.children, subs);
    }
  });
  return subs;
}

/**
* Returns a mapping or a list of mappings from a data competence object for use in the app
* @param comp {object} competence object or list of competence objects from the API
* @param type {string} goals OR competences
* @return {object}
*/
toView(comp, type){
  var f = (comp, type) => {
    return {
      name: comp.name,
      competence:comp.name,
      text: this.toIch(comp.name),
      courseId: comp.courseId,
      inCourse: comp.inCourse,
      progress: comp.progress,
      percent: comp.progress &amp;&amp; comp.progress.PROGRESS ? this.scales.progress.values[comp.progress.PROGRESS.assessmentIndex] : 0,
      //subCompetences: comp.competence,
      type:'competence',
      isGoal:type == 'goals',
      competenceData: comp,
    }
  }
  if(Array.isArray(comp)){
    return comp.map((c) => f(c, type));
  }
  return f(comp, type);
}

/**
* Change competence string from moodle-plugin-plural-format to Ich-Format
* @param name {string} Competence string
* @return {string}
*/
toIch(name){
  let die = name.startsWith('Die S.');
  if(name.startsWith('S.') || die) {
    let s = name.split(' ')
    let verb = s[die ? 2 : 1];
    let wholeVerb = verb;
    let last = s[s.length - 1].replace(/\./, '');
    //let index = lib.constants.verbs.indexOf(wholeVerb);
    let prefix = lib.constants.prefixes.indexOf(last) > - 1;
    if(prefix) {
      wholeVerb = last+verb;
      //index = lib.constants.verbs.indexOf(wholeVerb);
    }
    name = name.replace(/^(Die )?S\./, 'Ich');
    let newVerb = lib.functions.ich(wholeVerb).split(' ... ');
    name = name.replace(new RegExp(verb), newVerb[0]);
  }
  return name;
}

/**
* Get the sub competences of a competence from the API
* @param rootCompetence {object} The competenceId
* @param courseId {string} [university]
* @return  {Promise}
*/
getSubCompetences(rootCompetence, courseId = 'university'){
  var _this = this;
  return this.get('competences/', {rootCompetence: rootCompetence, courseId:courseId, asTree: true}).then((d) => {
    return _this.parseFromTree(d);
  });
}

}

module.exports = Competence;
</pre>
    </article>
</section>





		</div>
	</div>

	<div class="clearfix"></div>

	

</div>
</div>


    <div class="modal fade" id="searchResults">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">Search results</h4>
          </div>
          <div class="modal-body"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div>


<footer>


	<span class="copyright">
	Martin Kapp
	</span>

<span class="jsdoc-message">
	Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a>
	
		on 12.01.2017
	
	using the <a href="https://github.com/docstrap/docstrap">DocStrap template</a>.
</span>
</footer>

<script src="scripts/docstrap.lib.js"></script>
<script src="scripts/toc.js"></script>

    <script type="text/javascript" src="scripts/fulltext-search-ui.js"></script>


<script>
$( function () {
	$( "[id*='$']" ).each( function () {
		var $this = $( this );

		$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
	} );

	$( ".tutorial-section pre, .readme-section pre, pre.prettyprint.source" ).each( function () {
		var $this = $( this );

		var example = $this.find( "code" );
		exampleText = example.html();
		var lang = /{@lang (.*?)}/.exec( exampleText );
		if ( lang && lang[1] ) {
			exampleText = exampleText.replace( lang[0], "" );
			example.html( exampleText );
			lang = lang[1];
		} else {
			var langClassMatch = example.parent()[0].className.match(/lang\-(\S+)/);
			lang = langClassMatch ? langClassMatch[1] : "javascript";
		}

		if ( lang ) {

			$this
			.addClass( "sunlight-highlight-" + lang )
			.addClass( "linenums" )
			.html( example.html() );

		}
	} );

	Sunlight.highlightAll( {
		lineNumbers : true,
		showMenu : true,
		enableDoclinks : true
	} );

	$.catchAnchorLinks( {
        navbarOffset: 10
	} );
	$( "#toc" ).toc( {
		anchorName  : function ( i, heading, prefix ) {
			return $( heading ).attr( "id" ) || ( prefix + i );
		},
		selectors   : "#toc-content h1,#toc-content h2,#toc-content h3,#toc-content h4",
		showAndHide : false,
		smoothScrolling: true
	} );

	$( "#main span[id^='toc']" ).addClass( "toc-shim" );
	$( '.dropdown-toggle' ).dropdown();

    $( "table" ).each( function () {
      var $this = $( this );
      $this.addClass('table');
    } );

} );
</script>



<!--Navigation and Symbol Display-->

<script>
	$( function () {
		$( '#main' ).localScroll( {
			offset : { top : 60 } //offset by the height of your header (give or take a few px, see what works for you)
		} );
		$( "dt.name" ).each( function () {
			var $this = $( this ).find("h4");
			var icon = $( "<i/>" ).addClass( "icon-plus-sign" ).addClass( "pull-right" ).addClass( "icon-white" );
			var dt = $(this);
			var children = dt.next( "dd" );

			dt.prepend( icon ).css( {cursor : "pointer"} );
			dt.addClass( "member-collapsed" ).addClass( "member" );


			children.hide();

			dt.children().on( "click", function () {
				children = dt.next( "dd" );
				children.slideToggle( "fast", function () {

					if ( children.is( ":visible" ) ) {
						icon.addClass( "icon-minus-sign" ).removeClass( "icon-plus-sign" ).removeClass( "icon-white" );
						dt.addClass( "member-open" ).animate( "member-collapsed" );
					} else {
						icon.addClass( "icon-plus-sign" ).removeClass( "icon-minus-sign" ).addClass( "icon-white" );
						dt.addClass( "member-collapsed" ).removeClass( "member-open" );
					}
				} );
			} );

		} );
	} );
</script>


<!--Google Analytics-->



    <script type="text/javascript">
        $(document).ready(function() {
            SearcherDisplay.init();
        });
    </script>


</body>
</html>
